<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $http, $window, spScUtil, nowAttachmentHandler, spUtil, $log, spAriaUtil, $rootScope,$timeout) {
  

  var c = this;
	
	
	/******************************************************************
	 ********************** BEGIN c.readReviews ***********************
	 ******************************************************************
		This function gets called by button click inside html.
		------------------------------------------------------
		On Show Reviews Button Click:
		Check to see if a course is selected.
			If not throw error message and exit function.
		Otherwise update c.data.myCourseName to selected course name 
										 (input.myCourseName inside Server Script)
		Then update server: re-run entire server script
	********************************************************************/

	c.readReviews = function() {
		//alert(c.dropdownValue.value);
		if(c.dropdownValue.value == undefined || c.dropdownValue.value == "") {
			spUtil.addErrorMessage('You must select a '+ c.data.associatedWidgetMinusLastCharacter +' to see the reviews.');
			return;
		}
		
		//size word wrap and picture accordingly.
		// word wrap updates dynamically 
		// picture updates on click
		var widget = document.getElementById("widget-container");
		c.data.widgetWidth = widget.clientWidth;
		//alert(c.data.widgetWidth);
		
		
		c.data.myDropdownValue = c.dropdownValue.value;
		c.server.update();
	}
	
	/******************************************************************
	 *********************** END c.readReviews ************************
	 *****************************************************************/

	/*
	c.cancel = function() {
		// maybe you can close widget to make screen larger
		$rootScope.$broadcast("$sp.service_catalog.cart.place_order", true);
	} 
	*/
	
	
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.panel {
 max-width: 600px;
}

.center-div{

      margin-left: auto;

      margin-right: auto;

  float:none;

}
/*******************************************/
.wordwrap
{   
    width: data.widgetWidth;
    word-wrap: break-word;
}

.attachment-list {
  	max-height: 180px;
  	overflow-y: scroll;
  	margin-bottom: 10px;
}

.accordion-toggle {
  	line-height: 13px;
}

textarea {
	resize: vertical;
}

.select2-additional-display-field {
  padding-right: 5px;
}

/*
.myImage {
  src: data.picture;
  width: data.widgetWidth; 
  height: auto;
} */


div.image {
height: 200px;
width: 400px;
top: 99px;
left: 50px;
background-size: cover;
}

/* hard coded to match write a review widget original size */
.panel {
 min-height: 405px;
 //max-width: 600px;
}
/* ICON LINK CSS BEGIN:--------------------------------------------------------*/

.iconlink a label,h2 {
  display: block;
  font-size: 2.5rem;
  font-weight: 300;
  line-height: 1.1;
  padding: 0;
  margin: 0 0 10px 0;
}

/* TOP ICON ---------- */

a.top_icon {
  display: block;
  padding: 20px;
  text-align: center;
}

a.top_icon .fa {
  display: block;
  text-align: center;
}

/* CIRCLE ICON ---------- */

a.circle_icon {
  display: block;
  padding: 20px 0px 20px 70px;
  position: relative;
}

a.circle_icon .fa {
  position:absolute;
  left: 0px;
  top: 10px;
}

/* COLOR BOX ---------- */

a.color_box {
  display: block;
  position: relative;
  padding: 20px 20px 20px 82px;
  border-radius: 4px;
  margin-bottom: 20px;
}

a.color_box .fa {
  position:absolute;
  left: 20px;
  top: 20px;
  width:42px;
  text-align: center;
}

.icon-link-background-primary {
  background-color: $brand-primary;
}

.icon-link-background-info {
  background-color: $brand-info;
}

.icon-link-background-success {
  background-color: $brand-success;
}

.icon-link-background-warning {
  background-color: $brand-warning;
}

.icon-link-background-danger {
  background-color: $brand-danger;
}

.icon-link-background-default {
  background-color: $brand-primary;
}

.text-primary {
  color: $brand-primary;
  
  &amp;:hover {
    color: darken($brand-primary, 20%);
  }
}

.text-info {
  color: $brand-info;
  
  &amp;:hover {
    color: darken($brand-info, 20%);
  }
}

.text-success {
  color: $brand-success;
  
  &amp;:hover {
    color: darken($brand-success, 20%);
  }
}

.text-warning {
  color: $brand-warning;
  
  /*
  &amp;:hover {
    color: darken($brand-warning, 20%);
  }
  */
}

.text-danger {
  color: $brand-danger;
  
  &amp;:hover {
    color: darken($brand-danger, 20%);
  }
}

.text-default {
  color: $brand-primary;
  
  &amp;:hover {
    color: darken($brand-primary, 20%);
  }
}
/*-- ICON LINK CSS END:--------------------------------------------------------*/</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description>clone this and change a few things to get your review widget ready. Shows a list of your reviews</description>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>dynamic-see-reviews-widget</id>
        <internal>false</internal>
        <link/>
        <name>Dynamic See Reviews Widget</name>
        <option_schema>[{"name":"test_widget_option_schema","section":"Data","default_value":"see","label":"Test","type":"choice","choices":[{"label":"Parks","value":"Parks"},{"label":"Golf Courses","value":"Golf Courses"}]}]</option_schema>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
	//gs.addInfoMessage(options.test_widget_option_schema);
	
	if(options.test_widget_option_schema != 'see') {
		data.associatedWidget = (JSON.stringify(options.test_widget_option_schema)).slice(1,-1);
		data.defaultQueryString = 'associated_review_widget=' + data.associatedWidget;
		data.associatedWidgetMinusLastCharacter = (JSON.stringify(options.test_widget_option_schema));
		data.associatedWidgetMinusLastCharacter = ((data.associatedWidgetMinusLastCharacter).slice(1,-2));
		data.associatedWidgetMinusLastCharacterLowercase = data.associatedWidgetMinusLastCharacter.toLowerCase();
	}
	
	// data is an object accessible within whole widget 
	// requestList holds all of the queried review information for each review used in html file with ng-repeat
	data.requestList = [];
	//data.countAllStarsSubmitted = 0;
	//data.countAllReviewsSubmitted = 0;
	data.overallStarRating = 0;
	
	data.dynamicAllStarsTotal = 0;
	data.dynamicNumReviewsSubmitted = 0;
	data.dynamicOverallStarRating = 0;
	
	data.address = "";
	data.phoneNumber = "";
	


	/******************************************************************
	 ************************ BEGIN readReviews ***********************
	 ******************************************************************
		This function gets called by server update 
			 in client script function c.readReviews
		------------------------------------------------------
		Queries golf course review table and searches by course name.
		Grabs course name, description, course rating for each review and
		pushes it to requestList which is visible within entire widget.
		Keeps track of average star rating for each review to show an 
		overall course rating.
		
		Queries golf course select for general information to provide with overall review.
	********************************************************************/
if(input && input.action == 'readreviews') {
	
	//gs.addInfoMessage("assoc review widget: " + input.associatedWidget);
	// This table holds all the reviews for golf courses
	
	var target = new GlideRecord('x_339628_fairfaxco_all_reviews_from_review_widget'); 
	target.addQuery('associated_review_widget', '=', input.associatedWidget);
	target.addQuery('dropdown_value','=',input.myDropdownValue);
	target.addQuery('show_to_public', '!=', 'Rejected');
	target.orderByDesc('sys_created_on');
	target.query(); // Issue the query to the database to get relevant records 
	while (target.next()) { 
  
		var temp = {};

		temp.name = target.dropdown_value.toString();
		temp.description = target.description.toString();
		temp.star_rating = target.star_rating.toString();
		temp.date = target.sys_created_on.toString();

		data.requestList.push(temp);
	
		//data.countAllStarsSubmitted += Number(temp.star_rating);
		//data.countAllReviewsSubmitted++;
		
		
	}
	//gs.addInfoMessage("Original: All Stars: " + data.countAllStarsSubmitted + " # of Reviews: " + data.countAllReviewsSubmitted + "overall: " + data.countAllStarsSubmitted / data.countAllReviewsSubmitted);
	//data.overallStarRating = Math.round(data.countAllStarsSubmitted / data.countAllReviewsSubmitted);
	//gs.addInfoMessage("Overall: " + data.overallCourseRating);
	
	// This table holds all of the golf courses and their basic info. (One of each course)
	// This is table used when selecting a course
	
	var newtarget = new GlideRecord('x_339628_fairfaxco_dropdowns_for_review_widget'); 
	newtarget.addQuery('associated_review_widget', '=', input.associatedWidget);
	newtarget.addQuery('dropdown_value','=',input.myDropdownValue);
	newtarget.query(); // Issue the query to the database to get relevant records 
	while (newtarget.next()) {
		data.picture = newtarget.display_photo.getDisplayValue().toString();
		data.address = newtarget.address.toString();
		data.phoneNumber = newtarget.phone_number.toString();

		data.dynamicNumReviewsSubmitted = newtarget.number_of_reviews_submitted;
		data.dynamicOverallStarRating = newtarget.overall_star_rating;
		data.dynamicAllStarsTotal = newtarget.overall_star_rating * newtarget.number_of_reviews_submitted;
		
		// Calculate to show half stars
		var x = Math.floor(data.dynamicOverallStarRating);
		var y = data.dynamicOverallStarRating - x;
		if (y >= 0.3 && y <= 0.7) {
			data.overallStarRating = x + 0.5;
		}
		else {
			data.overallStarRating = Math.round(data.dynamicOverallStarRating);
		}
		//gs.addInfoMessage(data.overallStarRating);
		//gs.addInfoMessage("new: All Stars: " + data.dynamicAllStarsTotal + " # of Reviews: " + data.dynamicNumReviewsSubmitted + "overall: " + data.dynamicOverallStarRating);
		//gs.addInfoMessage(data.overallStarRating);
	}
	//gs.addInfoMessage(data.coursePicture);
}
  /*****************************************************************
	 ************************ END readReviews ************************
	 *****************************************************************/
	
	// not sure if this is important
	/* curious if its best practice to put data.action = inside 
	   client script functions when server.updates are called */
	data.action = options.action;
	if (data.action)
		data.item = options.item;
	else
		//data.action = 'checkout';
		data.action = 'readreviews';
	
	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2019-07-03 15:06:52</sys_created_on>
        <sys_id>b900e9234f567300496900fe9310c77f</sys_id>
        <sys_mod_count>67</sys_mod_count>
        <sys_name>Dynamic See Reviews Widget</sys_name>
        <sys_package display_value="FairfaxCounty" source="x_339628_fairfaxco">b1051ad14f413300496900fe9310c7cc</sys_package>
        <sys_policy/>
        <sys_scope display_value="FairfaxCounty">b1051ad14f413300496900fe9310c7cc</sys_scope>
        <sys_update_name>sp_widget_b900e9234f567300496900fe9310c77f</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2019-07-09 19:00:36</sys_updated_on>
        <template><![CDATA[<div id="widget-container" class="panel panel-default" min-height="900px">
	<h1 class="padder-md h3">${View }{{data.associatedWidget}}
    <span class="text-base">
  	  <i class="fa fa-close pull-right text-base" ng-click="c.cancel()"></i>
     </span>
  </h1>
	<div class="wrapper-md clearfix b-t">
		<div class="form-group">
			<div class="row">
				<div class="col-sm-8">
					<label for="dropdown_value">${Select a }{{data.associatedWidgetMinusLastCharacter}} <i class="fa fa-info-circle" uib-tooltip="${Please select a }{{data.associatedWidgetMinusLastCharacterLowercase}}${ to see the reviews.}" tooltip-placement="right" tooltip-append-to-body="true"></i></label>
					<!-- -------------------------------------------------- -->
  					<!-- ----------- Reference Search Bar ----------------- -->
 				    <!-- -------------------------------------------------- -->
          <sn-record-picker id="dropdown_value" 
                            field="c.dropdownValue" 
                            table="'x_339628_fairfaxco_dropdowns_for_review_widget'"
                          	display-field="'dropdown_value'"
                            value-field="'dropdown_value'"
                            default-query=${data.defaultQueryString}
                            page-size="100" 
                           >
          </sn-record-picker>
          									
				</div>
    
      
 </div>
   
		</div>

     <button name="submit" ng-click="c.readReviews()" class="btn sc-btn btn-primary pull-right m-l-xs">
  ${Show Reviews}
  </button>
    </div>
  
  <!-- -------------------------------------------------- -->
  <!-- ----------- BEGIN overall course review ---------- -->
  <!-- -------------------------------------------------- -->
  <!--
	-- Cloning Change: Change header
	-->
  <div ng-if="data.overallStarRating > 0">
     <h1 class="padder">{{data.myDropdownValue}}</h1>
     <h5 class="padder">Overall Review</h5>
 
     <div ng-if="data.overallStarRating == 1" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
         
        </div>
    <div ng-if="data.overallStarRating == 1.5" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star-half-o fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
         
        </div>
      <div ng-if="data.overallStarRating == 2" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
         
        </div>
    <div ng-if="data.overallStarRating == 2.5" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star-half-o fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
         
        </div>
      <div ng-if="data.overallStarRating == 3" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
         
        </div>
     <div ng-if="data.overallStarRating == 3.5" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star-half-o fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
         
        </div>
      <div ng-if="data.overallStarRating == 4" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-4x  text-warning"></div>
         
        </div>
     <div ng-if="data.overallStarRating == 4.5" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-half-o fa-4x  text-warning"></div>
         
        </div>
      <div ng-if="data.overallStarRating == 5" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-4x  text-warning"></div>
             <div id="4Star" class="m-b fa fa-star fa-4x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star fa-4x  text-warning"></div>
         
        </div>
		
		
     <img src="{{data.picture}}" width="100%" height="auto" />
    </div>
  
        
    

  <br />
   
  <div class="row padder" ng-if="data.overallStarRating > 0">
		<div class="col-xs-2" >Address:</div>
		<div class="col-xs-10" >{{data.address}}</div>  
		<div class="col-xs-2" >Phone:</div>
		<div class="col-xs-10" >{{data.phoneNumber}}</div>
 	
</div>
   <hr ng-if="data.overallStarRating > 0" /> 
  
  <!-- -------------------------------------------------- -->
  <!-- ----------- END overall course review ------------ -->
  <!-- -------------------------------------------------- -->
  
  <!-- -------------------------------------------------- -->
  <!-- ----------- BEGIN repeat all reviews ------------- -->
  <!-- -------------------------------------------------- -->
   <div ng-repeat="review in data.requestList | limitTo:50" class="each-incident">    
      
     
      <h1 class="padder">{{review.name}}</h1>
     
        <div ng-if="review.star_rating == 1" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
           <div id="4Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
         
        </div>
      <div ng-if="review.star_rating == 2" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
           <div id="4Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
         
        </div>
      <div ng-if="review.star_rating == 3" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-3x  text-warning"></div>
           <div id="4Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
         
        </div>
      <div ng-if="review.star_rating == 4" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-3x  text-warning"></div>
           <div id="4Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star-o fa-3x  text-warning"></div>
         
        </div>
      <div ng-if="review.star_rating == 5" class="col-sm-12" id="StarRatingView">
          
         	 <div id="1Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="2Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="3Star" class="m-b fa fa-star fa-3x  text-warning"></div>
           <div id="4Star" class="m-b fa fa-star fa-3x  text-warning"></div>
        	 <div id="5Star" class="m-b fa fa-star fa-3x  text-warning"></div>
         
        </div>
     <br /><br /><br />
      
      <p id="widgetDesc"  class="padder wordwrap">{{review.description}}</p>
     
   
     <!--	{{review.default_stars}} -->
    	<br />
			
      <p style="color:#BBBBBB; margin-bottom:0px;" class="padder pull-right">{{review.date}}</p>
      <hr /> 

  </div> 
  
  <!-- -------------------------------------------------- -->
  <!-- ------------- END repeat all reviews ------------- -->
  <!-- -------------------------------------------------- -->
  
	</div>
]]></template>
    </sp_widget>
</record_update>
